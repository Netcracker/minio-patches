name: Build MinIO Release (Makefile)

on:
  workflow_dispatch:
    inputs:
      minio-tag:
        description: "Upstream ref (tag/branch/commit) from minio/minio"
        required: true
        default: "master"

      run-integration-tests:
        description: "Run integration tests (verify-build.sh)"
        required: true
        default: false
        type: boolean

      run-healing-tests:
        description: "Run healing tests (verify-healing.sh)"
        required: true
        default: false
        type: boolean

      run-empty-erasure-set-healing-tests:
        description: "Run empty erasure set healing tests (verify-healing-empty-erasure-set.sh)"
        required: true
        default: false
        type: boolean

      run-healing-with-root-disks-tests:
        description: "Run healing with root disks tests (verify-healing-with-root-disks.sh)"
        required: true
        default: false
        type: boolean

      run-multipart-quorum-tests:
        description: "Run multipart quorum tests (multipart-quorum-test.sh)"
        required: true
        default: false
        type: boolean

      run-timeout-tests:
        description: "Run timeout tests (test-timeout.sh)"
        required: true
        default: false
        type: boolean

      run-erasure-mode-tests:
        description: "Run erasure mode tests (docker-compose)"
        required: true
        default: false
        type: boolean

env:
  MINIO_UPSTREAM_REPO: minio/minio

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout upstream MinIO
        uses: actions/checkout@v6
        with:
          repository: ${{ env.MINIO_UPSTREAM_REPO }}
          ref: ${{ inputs.minio-tag }}

      - name: Checkout Repo Patches
        uses: actions/checkout@v6
        with:
          path: minio-patches

      - name: Move patch file to root
        run: |
          mv  ./minio-patches/Dockerfile.release.local ./

      - name: Apply custom patches
        run: |
          cd ${GITHUB_WORKSPACE}
          for p in ./minio-patches/minio-patches/${{ inputs.minio-tag }}/*.patch; do
            echo "Applying $p…"
            git apply -p1 --ignore-space-change --ignore-whitespace "$p"
          done
          rm -rf ./minio-patches/minio-patches

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24.x"
          cache: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build binaries for multiple architectures
        working-directory: .
        run: |
          set -euo pipefail
          export MINIO_RELEASE=RELEASE
          export CGO_ENABLED=0

          # Build for each architecture
          for arch in amd64 arm64; do
            echo "Building for linux/${arch}..."
            GOOS=linux GOARCH=${arch} make build

            # Get version from amd64 binary (first iteration)
            if [ "${arch}" = "amd64" ]; then
              RELEASE_TAG=$(./minio --version | head -n1 | awk '{print $3}')
              echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV
              echo "Release: ${RELEASE_TAG}"
            fi

            # Prepare artifacts for each arch
            cp -f ./minio "minio-${arch}.${RELEASE_TAG:-$(./minio --version | head -n1 | awk '{print $3}')}"
            sha256sum "minio-${arch}.${RELEASE_TAG:-$(./minio --version | head -n1 | awk '{print $3}')}" > "minio-${arch}.${RELEASE_TAG:-$(./minio --version | head -n1 | awk '{print $3}')}.sha256sum"
          done

          # Download mc client for amd64 (used in tests)
          curl -fsSL "https://dl.min.io/client/mc/release/linux-amd64/mc" -o "mc"
          chmod +x "mc"
          sha256sum "mc" | awk '{print $1"  mc"}' > "mc.sha256sum"

      - name: Run integration tests
        if: ${{ inputs.run-integration-tests }}
        run: |
          set -euo pipefail
          bash buildscripts/verify-build.sh

      - name: Run healing tests
        if: ${{ inputs.run-healing-tests }}
        run: |
          set -euo pipefail
          bash buildscripts/verify-healing.sh

      - name: Run empty erasure set healing tests
        if: ${{ inputs.run-empty-erasure-set-healing-tests }}
        run: |
          set -euo pipefail
          bash buildscripts/verify-healing-empty-erasure-set.sh

      - name: Run healing with root disks tests
        if: ${{ inputs.run-healing-with-root-disks-tests }}
        run: |
          set -euo pipefail
          bash buildscripts/verify-healing-with-root-disks.sh

      - name: Run multipart quorum tests
        if: ${{ inputs.run-multipart-quorum-tests }}
        run: |
          set -euo pipefail
          bash buildscripts/multipart-quorum-test.sh

      - name: Run timeout tests
        if: ${{ inputs.run-timeout-tests }}
        working-directory: minio-src
        run: |
          set -euo pipefail
          bash buildscripts/test-timeout.sh

      - name: Compute lowercase owner for GHCR
        run: |
          echo "OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_ENV"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push multi-arch Docker image
        uses: docker/build-push-action@v6.18.0
        with:
          context: .
          file: ./Dockerfile.release.local
          platforms: linux/amd64,linux/arm64
          push: false
          tags: |
            ghcr.io/${{ env.OWNER }}/qubersip-minio:${{ env.RELEASE_TAG }}
            ghcr.io/${{ env.OWNER }}/qubersip-minio:latest
          build-args: |
            RELEASE=${{ env.RELEASE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Pull multi-arch image for testing
        run: |
          docker pull ghcr.io/${{ env.OWNER }}/qubersip-minio:${{ env.RELEASE_TAG }}
          docker tag ghcr.io/${{ env.OWNER }}/qubersip-minio:${{ env.RELEASE_TAG }} qubersip-minio:${{ env.RELEASE_TAG }}
          docker tag ghcr.io/${{ env.OWNER }}/qubersip-minio:${{ env.RELEASE_TAG }} qubersip-minio:latest

      - name: Test Docker image - smoke test
        run: |
          set -euo pipefail
          cid=$(docker run -d --rm \
            -p 9000:9000 -p 9001:9001 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            "qubersip-minio:${RELEASE_TAG}" server /data --console-address ":9001")

          for i in $(seq 1 60); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:9000/minio/health/ready || true)
            [ "$code" = "200" ] && break
            [ "$i" = "60" ] && { docker logs "$cid"; exit 1; }
            sleep 1
          done

          curl -fsSL "https://dl.min.io/client/mc/release/linux-amd64/mc" -o /tmp/mc
          chmod +x /tmp/mc
          /tmp/mc alias set local http://127.0.0.1:9000 minioadmin minioadmin
          /tmp/mc mb local/testbucket
          echo "test" | /tmp/mc pipe local/testbucket/test.txt
          /tmp/mc cat local/testbucket/test.txt | grep -q test

          docker stop "$cid" >/dev/null
          echo "✓ Smoke tests passed"

      - name: Test Docker image - erasure mode (Docker Compose)
        if: ${{ inputs.run-erasure-mode-tests }}
        run: |
          set -euo pipefail
          cat > /tmp/docker-compose.yml << 'EOF'
          version: '3.7'
          services:
            minio1:
              image: "qubersip-minio:${RELEASE_TAG}"
              ports:
                - "9000:9000"
              environment:
                MINIO_ROOT_USER: minioadmin
                MINIO_ROOT_PASSWORD: minioadmin
              command: server http://minio{1...4}/data --address ":9000"
              volumes:
                - /tmp/minio1:/data
              networks:
                - minio-net
            minio2:
              image: "qubersip-minio:${RELEASE_TAG}"
              ports:
                - "9001:9000"
              environment:
                MINIO_ROOT_USER: minioadmin
                MINIO_ROOT_PASSWORD: minioadmin
              command: server http://minio{1...4}/data --address ":9000"
              volumes:
                - /tmp/minio2:/data
              networks:
                - minio-net
            minio3:
              image: "qubersip-minio:${RELEASE_TAG}"
              ports:
                - "9002:9000"
              environment:
                MINIO_ROOT_USER: minioadmin
                MINIO_ROOT_PASSWORD: minioadmin
              command: server http://minio{1...4}/data --address ":9000"
              volumes:
                - /tmp/minio3:/data
              networks:
                - minio-net
            minio4:
              image: "qubersip-minio:${RELEASE_TAG}"
              ports:
                - "9003:9000"
              environment:
                MINIO_ROOT_USER: minioadmin
                MINIO_ROOT_PASSWORD: minioadmin
              command: server http://minio{1...4}/data --address ":9000"
              volumes:
                - /tmp/minio4:/data
              networks:
                - minio-net
          networks:
            minio-net:
              driver: bridge
          EOF

          # Replace tag placeholder (not needed, using ${RELEASE_TAG} directly)

          docker compose -f /tmp/docker-compose.yml up -d
          sleep 10

          # Test erasure mode
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:9000/minio/health/ready || true)
            [ "$code" = "200" ] && break
            [ "$i" = "30" ] && { echo "Timeout waiting for MinIO"; exit 1; }
            sleep 1
          done

          curl -fsSL "https://dl.min.io/client/mc/release/linux-amd64/mc" -o /tmp/mc
          chmod +x /tmp/mc
          /tmp/mc alias set erasure http://127.0.0.1:9000 minioadmin minioadmin
          /tmp/mc mb erasure/testbucket
          echo "erasure-test" | /tmp/mc pipe erasure/testbucket/test.txt
          /tmp/mc cat erasure/testbucket/test.txt | grep -q erasure-test

          docker compose -f /tmp/docker-compose.yml down
          echo "✓ Erasure mode tests passed"
